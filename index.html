// è¯•ç”¨é™åˆ¶åŠŸèƒ½
function checkTrialPeriod() {
    const FIRST_USE_KEY = 'first_use_timestamp';
    const TRIAL_DAYS = 7; // 7å¤©è¯•ç”¨æœŸ
    
    // è·å–é¦–æ¬¡ä½¿ç”¨æ—¶é—´
    let firstUseTime = localStorage.getItem(FIRST_USE_KEY);
    
    if (!firstUseTime) {
        // å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡ä½¿ç”¨ï¼Œè®°å½•å½“å‰æ—¶é—´
        firstUseTime = Date.now();
        localStorage.setItem(FIRST_USE_KEY, firstUseTime.toString());
        return true; // è¯•ç”¨æœŸåˆšå¼€å§‹
    }
    
    firstUseTime = parseInt(firstUseTime);
    const currentTime = Date.now();
    const trialEndTime = firstUseTime + (TRIAL_DAYS * 24 * 60 * 60 * 1000);
    
    // æ£€æŸ¥æ˜¯å¦è¶…è¿‡è¯•ç”¨æœŸ
    if (currentTime > trialEndTime) {
        showTrialExpiredDialog();
        return false;
    }
    
    return true;
}

// æ˜¾ç¤ºè¯•ç”¨åˆ°æœŸå¯¹è¯æ¡†
function showTrialExpiredDialog() {
    // åˆ›å»ºå¯¹è¯æ¡†é®ç½©
    const overlay = document.createElement('div');
    overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        padding: 20px;
    `;
    
    // åˆ›å»ºå¯¹è¯æ¡†å†…å®¹
    const dialog = document.createElement('div');
    dialog.style.cssText = `
        background: white;
        border-radius: 15px;
        padding: 30px 25px;
        text-align: center;
        max-width: 400px;
        width: 100%;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    `;
    
    dialog.innerHTML = `
        <div style="font-size: 3em; margin-bottom: 15px;">â°</div>
        <h2 style="color: #e74c3c; margin-bottom: 15px; font-size: 1.4em;">è¯•ç”¨å·²ç»“æŸ</h2>
        <p style="color: #666; line-height: 1.5; margin-bottom: 25px; font-size: 0.95em;">
            æ„Ÿè°¢æ‚¨ä½¿ç”¨å·ç åˆ†æå·¥å…·ï¼<br>
            7å¤©è¯•ç”¨æœŸå·²ç»“æŸï¼Œå¦‚éœ€ç»§ç»­ä½¿ç”¨ï¼Œè¯·è”ç³»ç®¡ç†äººå‘˜ã€‚
        </p>
        <div style="background: #f8f9fa; border-radius: 10px; padding: 15px; margin: 20px 0; border-left: 4px solid #3498db;">
            <strong style="color: #2c3e50;">è”ç³»æ–¹å¼ï¼š</strong>
            <p style="color: #7f8c8d; margin: 8px 0 0 0; font-size: 0.9em;">è¯·é€šè¿‡å®˜æ–¹æ¸ é“è”ç³»ç®¡ç†å‘˜è·å–æ­£å¼æˆæƒ</p>
        </div>
        <button onclick="closeTrialDialog()" style="
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            border: none;
            padding: 14px 30px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s ease;
        " onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
            ç¡®å®š
        </button>
    `;
    
    overlay.appendChild(dialog);
    document.body.appendChild(overlay);
    
    // ç¦ç”¨é¡µé¢æ»šåŠ¨
    document.body.style.overflow = 'hidden';
}

// å…³é—­è¯•ç”¨å¯¹è¯æ¡†
function closeTrialDialog() {
    const overlay = document.querySelector('div[style*="position: fixed"][style*="z-index: 10000"]');
    if (overlay) {
        document.body.removeChild(overlay);
        document.body.style.overflow = '';
    }
}

// åŒ…è£…åŸæœ‰åŠŸèƒ½å‡½æ•°ï¼Œæ·»åŠ è¯•ç”¨æ£€æŸ¥
const originalAnalyzeNumbers = analyzeNumbers;
analyzeNumbers = function() {
    if (!checkTrialPeriod()) return;
    return originalAnalyzeNumbers();
};

const originalShareResults = shareResults;
shareResults = function() {
    if (!checkTrialPeriod()) return;
    return originalShareResults();
};

const originalShowAllGroups = showAllGroups;
showAllGroups = function() {
    if (!checkTrialPeriod()) return;
    return originalShowAllGroups();
};

const originalJumpToGroup = jumpToGroup;
jumpToGroup = function(groupNumber, triple, level) {
    if (!checkTrialPeriod()) return;
    return originalJumpToGroup(groupNumber, triple, level);
};

const originalQuickViewAllGroups = quickViewAllGroups;
quickViewAllGroups = function(triple, level, groupIndices) {
    if (!checkTrialPeriod()) return;
    return originalQuickViewAllGroups(triple, level, groupIndices);
};

const originalClearHighlights = clearHighlights;
clearHighlights = function() {
    if (!checkTrialPeriod()) return;
    return originalClearHighlights();
};

// é¡µé¢åŠ è½½æ—¶æ£€æŸ¥è¯•ç”¨æœŸ
window.addEventListener('load', function() {
    console.log('ğŸ“± æ‰‹æœºç‰ˆå·ç åˆ†æå·¥å…·å·²åŠ è½½');
    console.log('ğŸš€ è‡ªåŠ¨ä¿å­˜åŠŸèƒ½å·²å¯ç”¨ - åˆ†æå®Œæˆåè‡ªåŠ¨ä¿å­˜åˆ°æœåŠ¡å™¨');
    console.log('ğŸ”— Supabase URL:', SUPABASE_URL);
    console.log('â° è¯•ç”¨é™åˆ¶åŠŸèƒ½å·²å¯ç”¨');
    
    // å»¶è¿Ÿæ£€æŸ¥è¯•ç”¨æœŸï¼Œè®©é¡µé¢å…ˆåŠ è½½å®Œæˆ
    setTimeout(() => {
        checkTrialPeriod();
    }, 1000);
});
